((self||window).webpackJsonp=(self||window).webpackJsonp||[]).push([[4],{1621:function(t,e,i){t.exports={btn:"tjs-augmented_virtuality_tool__btn tjs-_buttons__btn tjs-_buttons__btn tjs-nav__btn tjs-_buttons__btn","btn-primary":"tjs-augmented_virtuality_tool__btn-primary tjs-_buttons__btn tjs-_buttons__btn tjs-nav__btn tjs-_buttons__btn",btnPrimary:"tjs-augmented_virtuality_tool__btn-primary tjs-_buttons__btn tjs-_buttons__btn tjs-nav__btn tjs-_buttons__btn","btn-blink":"tjs-augmented_virtuality_tool__btn-blink tjs-_buttons__btn tjs-_buttons__btn tjs-nav__btn tjs-_buttons__btn",btnBlink:"tjs-augmented_virtuality_tool__btn-blink tjs-_buttons__btn tjs-_buttons__btn tjs-nav__btn tjs-_buttons__btn","btn-primary--hover":"tjs-augmented_virtuality_tool__btn-primary--hover",btnPrimaryHover:"tjs-augmented_virtuality_tool__btn-primary--hover",blinker:"tjs-augmented_virtuality_tool__blinker",toolButton:"tjs-augmented_virtuality_tool__toolButton",augmentedVirtualityTool:"tjs-augmented_virtuality_tool__augmentedVirtualityTool tjs-tool_button__toolButton"}},1622:function(t,e,i){"use strict";var a=_(i(8)),n=_(i(9)),r=_(i(22)),l=_(i(14)),o=_(i(43)),s=_(i(12)),u=_(i(354)),d=_(i(689));function _(t){return t&&t.__esModule?t:{default:t}}var h=function t(e){var i=this;this._terria=e,this._eventLoopState={},this._manualAlignment=!1,this._maximumUpdatesPerSecond=t.DEFAULT_MAXIMUM_UPDATES_PER_SECOND,this._orientationUpdated=!1,this._alpha=0,this._beta=0,this._gamma=0,this._realignAlpha=0,this._realignHeading=0,this._hoverLevel=t.PRESET_HEIGHTS.length-1,"ondeviceorientation"in window&&window.addEventListener("deviceorientation",(function(t){i._storeOrientation(t)})),r.default.track(this,["_eventLoopState","_manualAlignment","_maximumUpdatesPerSecond","_realignAlpha","_realignHeading","_hoverLevel"]),r.default.defineProperty(this,"enabled",{get:function(){return this._eventLoopRunning()||this._manualAlignment},set:function(t){!0!==t&&(t=!1,this.resetAlignment()),t!==this.enabled&&(this._manualAlignment=!1,this._startEventLoop(t))}}),r.default.defineProperty(this,"manualAlignment",{get:function(){return this._getManualAlignment()},set:function(t){this._setManualAlignment(t)}}),r.default.defineProperty(this,"manualAlignmentSet",{get:function(){return 0!==this._realignAlpha||0!==this._realignHeading}}),r.default.defineProperty(this,"hoverLevel",{get:function(){return this._hoverLevel}}),r.default.defineProperty(this,"maximumUpdatesPerSecond",{get:function(){return this._maximumUpdatesPerSecond},set:function(t){this._maximumUpdatesPerSecond=t,this._eventLoopRunning()&&(this._startEventLoop(!1),this._startEventLoop(!0))}}),this.enabled=!1};h.DEFAULT_MAXIMUM_UPDATES_PER_SECOND=10,h.MINIMUM_HOVER_HEIGHT=20,h.PRESET_HEIGHTS=[1e3,250,20],h.prototype.toggleEnabled=function(){this.enabled=!this.enabled},h.prototype.toggleManualAlignment=function(){this.manualAlignment=!this.manualAlignment},h.prototype.resetAlignment=function(){this._orientationUpdated=!0,this._realignAlpha=0,this._realignHeading=0},h.prototype.toggleHoverHeight=function(){this._hoverLevel=(this._hoverLevel+1)%h.PRESET_HEIGHTS.length,this.hover(h.PRESET_HEIGHTS[this._hoverLevel])},h.prototype.hover=function(t,e,i){var r=this;if((0,a.default)(this._terria.cesium)&&(0,a.default)(this._terria.cesium.viewer)&&(0,a.default)(this._terria.cesium.viewer.camera)){var l=this._terria.cesium.viewer.camera;if((0,a.default)(e)||(e=l.positionCartographic.clone()),i=(0,n.default)(i,!0),t<h.MINIMUM_HOVER_HEIGHT&&(t=h.MINIMUM_HOVER_HEIGHT),!(0,a.default)(this._terria.cesium)||!(0,a.default)(this._terria.cesium.scene)||!(0,a.default)(this._terria.cesium.scene.terrainProvider)||this._terria.cesium.scene.terrainProvider instanceof u.default)_(0);else{var o=this._terria.cesium.scene.terrainProvider;(0,d.default)(o,[e]).then((function(t){_(t[0].height)}))}}function _(n){(0,a.default)(n)&&(t+=n);var o=s.default.fromRadians(e.longitude,e.latitude,t),u=r._getCurrentOrientation();u.destination=o,i?l.flyTo(u):l.setView(u),r._terria.currentViewer.notifyRepaintRequired()}},h.prototype.moveTo=function(t,e,i){var n=this;if(!this._manualAlignment&&(0,a.default)(this._terria.cesium)&&(0,a.default)(this._terria.cesium.viewer)&&(0,a.default)(this._terria.cesium.viewer.camera)){var r=this._terria.cesium.viewer.camera.positionCartographic.clone(),l=r.height;if(!(0,a.default)(this._terria.cesium)||!(0,a.default)(this._terria.cesium.scene)||!(0,a.default)(this._terria.cesium.scene.terrainProvider)||this._terria.cesium.scene.terrainProvider instanceof u.default)s(void 0);else{var o=this._terria.cesium.scene.terrainProvider;(0,d.default)(o,[r]).then((function(t){s(t[0].height)}))}}function s(r){(0,a.default)(r)||(r=0);var o=l-r;(0,a.default)(e)&&o>e&&(o=e),n.hover(o,t,i)}},h.prototype._getManualAlignment=function(){return this.enabled&&this._manualAlignment},h.prototype._setManualAlignment=function(t){!0===this.enabled&&(!0!==t&&(t=!1),!1===t&&(0,a.default)(this._terria.cesium)&&(0,a.default)(this._terria.cesium.viewer)&&(0,a.default)(this._terria.cesium.viewer.camera)&&(this._realignAlpha=this._alpha,this._realignHeading=l.default.toDegrees(this._terria.cesium.viewer.camera.heading)),this._manualAlignment!==t&&(this._manualAlignment=t,this._startEventLoop(!this._manualAlignment)))},h.prototype._eventLoopRunning=function(){return(0,a.default)(this._eventLoopState.intervalId)},h.prototype._startEventLoop=function(t){if(this._eventLoopRunning()!==t)if(!0===t){var e=this;this._orientationUpdated=!0;var i=1e3/this._maximumUpdatesPerSecond,a=setInterval((function(){e._updateOrientation()}),i);this._eventLoopState={intervalId:a}}else clearInterval(this._eventLoopState.intervalId),this._eventLoopState={}},h.prototype._storeOrientation=function(t){this._alpha=t.alpha,this._beta=t.beta,this._gamma=t.gamma,this._orientationUpdated=!0},h.prototype._updateOrientation=function(){var t=this._getCurrentScreenOrientation();(t!==this._lastScreenOrientation&&(this._orientationUpdated=!0),this._lastScreenOrientation=t,this._orientationUpdated)&&(this._orientationUpdated=!1,(0,a.default)(this._terria.cesium)&&(0,a.default)(this._terria.cesium.viewer)&&(0,a.default)(this._terria.cesium.viewer.camera)&&(this._terria.cesium.viewer.camera.setView(this._getCurrentOrientation(t)),this._terria.currentViewer.notifyRepaintRequired()))},h.prototype._getCurrentOrientation=function(t){var e=this._alpha,i=this._beta,n=this._gamma,r=this._realignAlpha,l=this._realignHeading;return(0,a.default)(t)||(t=this._getCurrentScreenOrientation()),this._computeTerriaOrientation(e,i,n,t,r,l)},h.prototype._computeTerriaOrientation=function(t,e,i,a,n,r){var s,u=o.default.clone(o.default.IDENTITY,u);s=o.default.fromRotationZ(l.default.toRadians(a)),o.default.multiply(u,s,u),s=o.default.fromRotationX(l.default.toRadians(90)),o.default.multiply(u,s,u),s=o.default.fromRotationZ(l.default.toRadians(i)),o.default.multiply(u,s,u),s=o.default.fromRotationX(l.default.toRadians(-e)),o.default.multiply(u,s,u),s=o.default.fromRotationY(l.default.toRadians(-(t-n))),o.default.multiply(u,s,u),s=o.default.fromRotationY(l.default.toRadians(r)),o.default.multiply(u,s,u);var d=u[o.default.COLUMN1ROW0],_=u[o.default.COLUMN1ROW1],h=u[o.default.COLUMN0ROW2],m=u[o.default.COLUMN1ROW2],f=u[o.default.COLUMN2ROW2],g=l.default.toDegrees(Math.atan2(-h,f)),c=l.default.toDegrees(Math.atan2(-d,_)),p=l.default.toDegrees(Math.atan2(-m,Math.sqrt(h*h+f*f)));return{orientation:{roll:l.default.toRadians(c),pitch:l.default.toRadians(p),heading:l.default.toRadians(g)}}},h.prototype._getCurrentScreenOrientation=function(){return(0,a.default)(screen.orientation)&&(0,a.default)(screen.orientation.angle)?screen.orientation.angle:(0,a.default)(window.orientation)?window.orientation:0},t.exports=h},760:function(t,e,i){"use strict";var a=m(i(11)),n=m(i(17)),r=m(i(13)),l=m(i(19)),o=m(i(1621)),s=m(i(36)),u=m(i(172)),d=m(i(8)),_=i(26),h=m(i(1622));function m(t){return t&&t.__esModule?t:{default:t}}var f=(0,n.default)({displayName:"AugmentedVirtualityTool",mixins:[l.default],propTypes:{terria:r.default.object.isRequired,viewState:r.default.object.isRequired,experimentalWarning:r.default.bool,t:r.default.func.isRequired},getInitialState:function(){return{augmentedVirtuality:new h.default(this.props.terria),experimentalWarningShown:!1,realignHelpShown:!1,resetRealignHelpShown:!1}},handleClickAVTool:function(){if(this.props.terria.augmentedVirtuality=this.state.augmentedVirtuality,(0,d.default)(this.props.experimentalWarning)&&!1!==this.props.experimentalWarning&&!this.state.experimentalWarningShown){this.setState({experimentalWarningShown:!0});var t=this.props.t;this.props.viewState.notifications.push({title:t("AR.title"),message:t("AR.experimentalFeatureMessage"),confirmText:t("AR.confirmText")})}this.state.augmentedVirtuality.toggleEnabled()},handleClickRealign:function(){if(!this.state.realignHelpShown){this.setState({realignHelpShown:!0});var t=this.props.t;this.props.viewState.notifications.push({title:t("AR.manualAlignmentTitle"),message:t("AR.manualAlignmentMessage",{img:'<img width="100%" src="./build/TerriaJS/images/ar-realign-guide.gif" />'}),confirmText:t("AR.confirmText")})}this.state.augmentedVirtuality.toggleManualAlignment()},handleClickResetRealign:function(){if(!this.state.resetRealignHelpShown){this.setState({resetRealignHelpShown:!0});var t=this.props.t;this.props.viewState.notifications.push({title:t("AR.resetAlignmentTitle"),message:t("AR.resetAlignmentMessage"),confirmText:t("AR.confirmText")})}this.state.augmentedVirtuality.resetAlignment()},handleClickHover:function(){this.state.augmentedVirtuality.toggleHoverHeight()},render:function(){var t=this.state.augmentedVirtuality.enabled,e=s.default.GLYPHS.arOff,i=o.default.btn;t&&(e=s.default.GLYPHS.arOn,i=o.default.btnPrimary);var n=this.props.t,r=this.state.augmentedVirtuality.manualAlignment,l=o.default.btn;r&&(l=o.default.btnBlink);var d=this.state.augmentedVirtuality.hoverLevel,_=s.default.GLYPHS.arHover0;switch(d){case 0:_=s.default.GLYPHS.arHover0;break;case 1:_=s.default.GLYPHS.arHover1;break;case 2:_=s.default.GLYPHS.arHover2}return this.props.terria.viewerMode!==u.default.Leaflet?a.default.createElement("div",{className:o.default.augmentedVirtualityTool},a.default.createElement("button",{type:"button",className:i,title:n("AR.arTool"),onClick:this.handleClickAVTool},a.default.createElement(s.default,{glyph:e})),t?[a.default.createElement("button",{type:"button",className:o.default.btn,title:n("AR.btnHover"),onClick:this.handleClickHover,key:"0"},a.default.createElement(s.default,{glyph:_})),this.state.augmentedVirtuality.manualAlignmentSet?null:a.default.createElement("button",{type:"button",className:l,title:n("AR.btnRealign"),onClick:this.handleClickRealign,key:"1"},a.default.createElement(s.default,{glyph:s.default.GLYPHS.arRealign})),this.state.augmentedVirtuality.manualAlignmentSet&&!r?a.default.createElement("button",{type:"button",className:o.default.btn,title:n("AR.btnResetRealign"),onClick:this.handleClickResetRealign,key:"2"},a.default.createElement(s.default,{glyph:s.default.GLYPHS.arResetAlignment})):null]:null):null}});t.exports=(0,_.withTranslation)()(f)}}]);
//# sourceMappingURL=4.TerriaMap.js.map